
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Rock! Markdown编辑器开发手记</title>
    
    <meta name="author" content="柳裟">
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

      <link href="/assets/themes/twitter/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
      <link href="/assets/themes/twitter/stylesheets/gfm.css" media="screen, projection" rel="stylesheet" type="text/css">
      <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
      <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
      <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
      <![endif]-->

    <!-- atom & rss feed -->
    <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>

    <!-- start -->
    <div class="container">
        <div class="left-col">
            <div class="intrude-less">
                <header id="header" class="inner">
                    <div class="profilepic">
                        <img src='https://0.gravatar.com/avatar/372a13c579567ea98cafb3030289b63d?d=https%3A%2F%2Fidenticons.github.com%2Fffce3aba86b100da21f2295272398204.png&s=160' alt='Profile Picture' style='width: 160px;'>
                    </div>
                    <h1><a href="/">将材柳裟</a></h1>
                    <p class="subtitle"></p>
                    <nav id="main-nav">
                        <ul class="main">
                            <li><a href="/">博客</a></li>
                            <li><a href="/archive.html">文章列表</a></li>
                            <li><a href="/lab.html">实验室</a></li>
                        </ul>

                        <section class="aboutme">
                            <p>
                                Hi，我是柳裟，我目前在杭州，主要做前端开发的工作，兴趣于Web开发技术，这是我的博客，所记载偏技术，但可灵感可生活，喜欢和聪明的人打交道。
                            </p>
                        </section>
                    </nav>
                    <nav id="sub-nav">
                        <div class="social">
                            <a class="twitter" href="" title="暂时没有">Twitter</a>
                            <a class="github" href="https://github.com/superRaytin" title="GitHub">GitHub</a>
                            <a class="rss" href="/rss.xml" title="RSS">RSS</a>
                        </div>
                    </nav>
                </header>
            </div>
        </div>

        <div class="mid-col">
            <div class="mid-col-container">
                <div id="content" class="inner">
                        
<article class="post">
    <div class="meta">
        <div class="date">
            <time datetime='' data-updated="true" itemprop="datePublished">2013-08-23</time>
        </div>
        
        <div class="tags">
            
            


  
     
    	<a class="category" href="/tags.html#node-webkit-ref">node-webkit</a>&nbsp;
    
  



        </div>
        
    </div>
    <h1 class="title">Rock! Markdown编辑器开发手记</h1>
    <div class="entry markdown-body">
        <h2>前言</h2>

<p>因为每周都要写周报，用markdown写文档是我的首选，不只是因为它的简洁高效，排版。公司办公电脑大都是win7系统，而windows平台markdown编辑器不多，其中功能比较好的当属markdownpad了，可打开速度每次都要让我菊花一紧，界面更谈不上美观，
没用多久便卸载了，转到在线编辑器，一个不错的就是 <code>http://mahua.jser.me</code>，体验还不错，在线编辑器虽然方便，却也有其局限性，如果既能写文档，也能将本地众多的md文档管理起来，写完之后还能直接发邮件，想想多么酷~！
再加上之前接触到 <a href="https://github.com/rogerwang/node-webkit">Node-webkit</a> ，于是萌生了自己写一个编辑器的想法。</p>

<p>如果你不了解Node-webkit是什么，可以在网上搜一下资料，也可看看 <a href="/skill/2013/07/15/node-webkit-desktop-app-develop/">以web的方式写桌面程序——Node-Webkit</a></p>

<h2>最终的界面</h2>

<p><img class="lazy" src="/assets/posts/images/grey.gif" data-original="/assets/posts/images/rock-markdown-1.png"></p>

<h2>功能分布</h2>

<p>编辑器的布局从上到下：</p>

<ul>
<li>菜单栏</li>
<li>工具栏</li>
<li>标签栏</li>
<li>编辑区</li>
<li>预览区</li>
<li>状态栏</li>
</ul>


<p>布局上借鉴了markdownpad，菜单栏的实现主要借助了Node-webkit（以下简称nw）的 <code>Menu</code> API，用法很简单：</p>

<pre><code>var gui = require('nw.gui');
var fileMenu = new gui.Menu();
fileMenu.append({
    label: '新建文档 (Ctrl+N)',
    click: function(){
        ...
    }
});
</code></pre>

<p>菜单栏包含了整个编辑器所有的功能。</p>

<p>工具栏提供一些常用功能的快捷调用。</p>

<p>状态栏显示当前文档的信息。</p>

<h2>用到的库</h2>

<p>编辑区用的是 <code>codemirror</code>，关于 <a href="http://codemirror.net">codeMirror</a>：</p>

<blockquote><p>CodeMirror 是一款“Online Source Editor”，基于Javascript，短小精悍，实时在线代码高亮显示，他不是某个富文本编辑器的附属产品，他是许多大名鼎鼎的在线代码编辑器的基础库。</p></blockquote>

<p>解释markdown标记用到 <a href="https://github.com/coreyti/showdown">showdown</a></p>

<p>邮件发送直接用Node第三方模块 <code>Node-mailer</code> 速度非常快。</p>

<h2>多标签</h2>

<p>考虑到性能原因，编辑器采用了单例模式，即所有产生的标签都是在一个editor实例上进行操作，切换标签实际上是将新的一份标签信息
push到编辑器，当用户新建标签时，即在cache里开辟一个新的存储单元，存储这个标签的所有信息，包括后来用户交互产生的信息。</p>

<p>关闭标签会将相应的存储单元删除，当用户关闭编辑器时会将当前打开的标签进行本地保存。</p>

<p>切换标签时，会对编辑器的内容，以及操作历史进行保存，以便可以撤销(undo)和重做(redo)。</p>

<h2>数据存储</h2>

<p>由于localStorage有大小限制，所以我曾想过用本地文件来做数据存储，后来因为一些原因没有采用。</p>

<p>其一，我发现nw的机制是，当运行nw程序时，nw会在本机用户目录的appData里创建临时文件，这些文件就是程序的源代码，程序退出时，临时文件会被删除，保存在程序目录里不可行；</p>

<p>其二，如果保存在程序目录以外的地方，可能会受到其他程序的影响以及用户的误操作等</p>

<p>综上，最后决定是所有用户个性化数据都用localStorage进行保存，只针对一些关键数据作保存。比如保存标签的信息中并不会保存编辑区的内容，而只是保存了
标签所对应文件的url，用户下次打开时会重新读取url对应的磁盘文件。</p>

<h2>源文件暴露问题</h2>

<p>上面讲到的nw机制，nw程序运行会把源文件解压到appData临时文件，这样就暴露了源代码，虽然我已做了开源，并不担心源代码暴露问题。
但为了研究别人怎么处理这个问题的，我对lightTable——一款老外用nw写的IDE，进行了研究，
我把lightTable运行时解压出来的文件拖到nw的壳执行时，发现运行会出错，就很好奇是怎么做到的，难道作者对代码做了处理。一时无解。</p>

<h2>下载</h2>

<p>最新版本：Beta V0.1.2</p>

<ul>
<li>Windows 32bit:

<ul>
<li><a href="http://yunpan.cn/QXi3BSFrNCWGN">云盘下载</a>(推荐)</li>
<li><a href="http://www.jsfor.com/project/rock/Rock!_Markdown_Editor_v0.1.2_win32bit.zip">备用下载</a></li>
</ul>
</li>
</ul>


<p>PS：以上32位版本，在64位系统上测试通过是可以使用的，不过不排除某些情况下失效，原因未知。</p>

    </div>
</article>

<nav id="pagenavi">
    <a href="/skill/2013/09/07/jekyll-local-structures-notes" class="next">Next</a>
    <div class="center"><a href="/archive.html">Blog Archives</a></div>
</nav>

<script type="text/javascript" charset="utf-8">
    var disqus_url = "http://superraytin.github.com/skill/2013/08/23/rock-markdown-editor-develop-notes";
</script>

<!--
<p>
    <span class="showComment" id="J-showComment">comments ↓</span>
</p>
<div id="disqus_thread" class="height0"></div>
-->
<div id="disqus_thread" class="mt20"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'raytinspace'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


                    <!--
                    <nav id="pagenavi">
                        <a href="/blog/page/2/" class="next">Next</a>
                        <div class="center"><a href="/blog/archives">Blog Archives</a></div>
                    </nav>
                    -->
                </div>
            </div>
            <footer id="footer" class="inner">
                Copyright &copy; 2013 superRaytin
                Powered by <a href="http://jekyllbootstrap.com">Jekyll</a>
                Design from <a href="http://shashankmehta.in/archive/2012/greyshade.html">Greyshade</a>
            </footer>
            <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
            <script src="/assets/themes/twitter/javascripts/jquery.lazyload.min.js"></script>
            <script src="/assets/themes/twitter/javascripts/common.js"></script>
        </div>
    </div>
    <!-- end -->
    
  </body>
</html>
